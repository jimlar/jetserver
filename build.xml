<?xml version="1.0"?>

<project name="JetServer" default="jetserver" basedir=".">

  <property name="build.compiler" value="jikes" />

  <property name="classpath" value="src:
				    build/classes:
                                    lib/xerces.jar:
                                    lib/concurrent.jar:
                                    lib/servlet.jar" />

  <!-- jetserver -->
  <target name="jetserver" depends="compile">
    <jar jarfile="build/jetserver.jar"
         basedir="build/classes"
         manifest="src/MANIFEST.MF"/>
  </target>

  <!-- clean -->
  <target name="clean">
    <delete dir="build" />
    <delete>
      <fileset dir="testapplication/web/WEB-INF/classes" includes="**/*.class"/>
      <fileset dir="testapplication/ejb" includes="**/*.class"/>
    </delete>
  </target>

  <!-- compile -->
  <target name="compile">
    <mkdir dir="build/classes"/>

    <javac destdir="build/classes"
	   classpath="${classpath}"
	   includes="**/*.java">

      <src path="src"/>
    </javac>

    <copy todir="build/classes">
      <fileset dir="src" includes="**/*.dtd" />
    </copy>

    <copy todir="build">
      <fileset dir="." includes="lib/*.jar" />
      <fileset dir="." includes="config/*.xml,config/mime.types" />
      <fileset dir="." includes="html/*.html" />
    </copy>

  </target>


  <!-- test application -->
  <target name="testapplication">

    <!-- The test ejb jar -->
    <javac destdir="testapplication/ejb"
	   classpath="${classpath}"
	   includes="**/*.java">

      <src path="testapplication/ejb"/>
    </javac>

    <jar jarfile="testapplication/ejb.jar"
         basedir="testapplication/ejb" />

    <!-- The test web app -->
    <javac destdir="testapplication/web/WEB-INF/classes"
	   classpath="${classpath}:testapplication/ejb"
	   includes="**/*.java">

      <src path="testapplication/web/WEB-INF/classes"/>
    </javac>

    <jar jarfile="testapplication/web.war"
         basedir="testapplication/web" />

    <!-- Ear it together -->
    <mkdir dir="build/dropzone"/>
    <jar jarfile="build/dropzone/testapplication.ear"
         basedir="testapplication"
         includes="*web.war, ejn.jar, META-INF/*.xml" />

  </target>


  <!-- start server -->
  <target name="start" depends="jetserver, testapplication">
    <java classname="jetserver.server.JetServer"
          classpath="${classpath}"
          fork="true"
          dir="build">
    </java>
  </target>

  <!-- start benchmarking -->
  <target name="benchmark">

    <echo message=""/>
    <echo message="Benchmarking HTML file"/>
    <echo message="http://localhost:8080/hellocontainer.html" file="build/benchmark_urls"/>
    <exec executable="./tools/http_load">
      <arg line="-parallel 40 -fetches 2000 build/benchmark_urls"/>
    </exec>

    <echo message=""/>
    <echo message="Benchmarking Servlet"/>
    <echo message="http://localhost:8080/hellocontainer" file="build/benchmark_urls"/>
    <exec executable="./tools/http_load">
      <arg line="-parallel 40 -fetches 2000 build/benchmark_urls"/>
    </exec>
  </target>

</project>
